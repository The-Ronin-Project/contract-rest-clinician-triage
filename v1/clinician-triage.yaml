openapi: 3.0.0
info:
  title: Clinician Triage Service Contract
  description: API contract for the Clinician Triage Service
  version: 1.1.0
  contact:
    name: David Dionise
    email: ddionise@projectronin.com
servers:
  - url: /api/v1
tags:
  - name: Care Team Response
    description: Endpoints for creating and updating clinician communication
  - name: Patient Reported Symptoms
    description: Endpoints for fetching questionnaires that have been completed by a patient

paths:
  /care_team_response/draft:
    put:
      tags:
        - Care Team Response
      description: Create or update a care team response draft
      summary: Create/Update Care Team Response Draft
      operationId: upsertCareTeamResponse
      security:
        - bearerAuth: []
      parameters:
        - in: query
          schema:
            type: string
          name: survey_response_id
          required: true
          example: fa3b78ce-c27b-11ed-afa1-0242ac120002
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CareTeamResponseRequestBody"
            example:
              option: schedule_visit
              comment: You should get in to see the doctor this week
        required: true
      responses:
        '202':
          description: Successful upsert of care team response draft
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                BadRequestError:
                  $ref: "#/components/examples/BadRequestError"
                DuplicateResource:
                  $ref: "#/components/examples/DuplicateResource"
        '404':
          description: Resource Not Found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                BadRequestError:
                  $ref: "#/components/examples/NotFoundError"
        '500':
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                BadRequestError:
                  $ref: "#/components/examples/InternalServerError"
  /care_team_response:
    post:
      tags:
        - Care Team Response
      description: Create a care team response for the associated survey response
      summary: Create Care Team Response
      operationId: createCareTeamResponse
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: survey_response_id
          schema:
            type: string
          required: true
          example: fa3b78ce-c27b-11ed-afa1-0242ac120002
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CareTeamResponseRequestBody"
            example:
              option: schedule_visit
              comment: You should get in to see the doctor this week
        required: true
      responses:
        '201':
          description: Successful creation of care team response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CareTeamResponseResponse'
              examples:
                CreateCareTeamResponseExample:
                  $ref: '#/components/examples/CreateCareTeamResponseExample'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                BadRequestError:
                  $ref: "#/components/examples/BadRequestError"
                DuplicateResource:
                  $ref: "#/components/examples/DuplicateResource"
        '404':
          description: Resource Not Found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                BadRequestError:
                  $ref: "#/components/examples/NotFoundError"
        '500':
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                BadRequestError:
                  $ref: "#/components/examples/InternalServerError"
    get:
      tags:
        - Care Team Response
      summary: Fetch Care Team Response
      description: Fetch care team response for the patient app
      operationId: fetchCareTeamResponse
      security:
        - bearerAuth: []
      parameters:
        - name: survey_response_id
          in: query
          schema:
            type: string
          required: true
          example: fa3b78ce-c27b-11ed-afa1-0242ac120002
      responses:
        '200':
          description: Successfully fetch care team response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CareTeamResponseResponse'
              examples:
                CreateCareTeamResponseExample:
                  $ref: '#/components/examples/CreateCareTeamResponseExample'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                BadRequestError:
                  $ref: "#/components/examples/BadRequestError"
                DuplicateResource:
                  $ref: "#/components/examples/DuplicateResource"
        '404':
          description: Resource Not Found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                BadRequestError:
                  $ref: "#/components/examples/NotFoundError"
        '500':
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                BadRequestError:
                  $ref: "#/components/examples/InternalServerError"
  /care_team_response/{careTeamResponseId}/sign:
    patch:
      tags:
        - Care Team Response
      summary: Sign Care Team Response
      description: >-
        Sign a care team response. May include an internal note
      operationId: signCareTeamResponse
      security:
        - bearerAuth: []
      parameters:
        - name: careTeamResponseId
          in: path
          required: true
          example: a608bf12-8fa2-404c-ad99-163a487ffbb0
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SignCareTeamResponseRequestBody"
            example:
              internal_note: Patient needs blood drawn
        required: true
      responses:
        '200':
          description: Successful signing of care team response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CareTeamResponseResponse'
              examples:
                CareTeamResponseExample:
                  $ref: '#/components/examples/SignCareTeamResponseExample'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/AbstractResponse"
                  - type: object
                    properties:
                      errors:
                        type: array
                        items:
                          $ref: "#/components/schemas/Error"
              examples:
                BadRequestError:
                  $ref: "#/components/examples/BadRequestError"
        '404':
          description: Resource Not Found
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/AbstractResponse"
                  - type: object
                    properties:
                      errors:
                        type: array
                        items:
                          $ref: "#/components/schemas/Error"
              examples:
                BadRequestError:
                  $ref: "#/components/examples/NotFoundError"
        '409':
          description: Duplicate Signature
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/AbstractResponse"
                  - type: object
                    properties:
                      errors:
                        type: array
                        items:
                          $ref: "#/components/schemas/Error"
              examples:
                BadRequestError:
                  $ref: "#/components/examples/DuplicateSignature"
        '500':
          description: Internal Server Error
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/AbstractResponse"
                  - type: object
                    properties:
                      errors:
                        type: array
                        items:
                          $ref: "#/components/schemas/Error"
              examples:
                BadRequestError:
                  $ref: "#/components/examples/InternalServerError"
  /care_team_response/{careTeamResponseId}/read:
    patch:
      tags:
        - Care Team Response
      summary: Mark Care Team Response as Read
      description: >-
        Mark the Care Team Response as having been read by the patient
      operationId: markCareTeamResponseAsRead
      security:
        - bearerAuth: []
      parameters:
        - name: careTeamResponseId
          in: path
          required: true
          example: 25e4822e-c289-11ed-afa1-0242ac120002
          schema:
            type: string
      responses:
        '200':
          description: Successfully updated the care team response as "read"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CareTeamResponseResponse'
              examples:
                CareTeamResponseExample:
                  $ref: '#/components/examples/MarkCareTeamResponseAsReadExample'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                BadRequestError:
                  $ref: "#/components/examples/BadRequestError"
        '404':
          description: Resource Not Found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                BadRequestError:
                  $ref: "#/components/examples/NotFoundError"
        '500':
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                BadRequestError:
                  $ref: "#/components/examples/InternalServerError"
  /symptoms:
    get:
      tags:
        - Patient Reported Symptoms
      description: Fetch questionnaires that have been completed by a patient
      summary: Fetch Patient Reported Symptoms
      operationId: fetchPatientReportedSymptoms
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: patient_id
          schema:
            type: string
          required: true
          example: b02cadd0-c27f-11ed-afa1-0242ac120002
      responses:
        '200':
          description: Successful fetch of patient reported symptoms
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PatientReportedSymptomsResponse'
              examples:
                PatientReportedSymptomsResponseExample:
                  $ref: '#/components/examples/PatientReportedSymptomsResponseExample'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                BadRequestError:
                  $ref: "#/components/examples/BadRequestError"
        '404':
          description: Resource Not Found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                BadRequestError:
                  $ref: "#/components/examples/NotFoundError"
        '500':
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                BadRequestError:
                  $ref: "#/components/examples/InternalServerError"

components:
  schemas:
    AbstractResponse:
      type: object
      properties:
        meta:
          type: object
          properties:
            links:
              type: object
              properties:
                self:
                  type: string
                  description: Path of the API request
              additionalProperties: true
            version:
              type: string
              description: Semver version of the API
    CareTeamResponseRequestBody:
      type: object
      properties:
        option:
          type: string
        comment:
          type: string
      required:
        - option
    SignCareTeamResponseRequestBody:
      type: object
      properties:
        internal_note:
          type: string
    CareTeamResponseResponse:
      description: >-
        Data pertaining to the messages that clinicians send to the patients,
        and notes that are stored for internal use
      allOf:
        - $ref: "#/components/schemas/AbstractResponse"
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/CareTeamResponse'
    CareTeamResponse:
      type: object
      nullable: true
      properties:
        id:
          type: string
        is_draft:
          type: boolean
        responder:
          $ref: "#/components/schemas/Responder"
        patient_message:
          type: object
          properties:
            option:
              type: string
              description: >-
                Message sent from the clinician to the patient. Chosen from a
                set number of options
            display:
              type: string
              description: >-
                The display value of the `option` enum
              nullable: true
            comment:
              type: string
              description: Custom comment sent to patient from the clinician
              nullable: true
        internal_note:
          type: string
          description: Optional note that the clinician can store for internal use
          nullable: true
        signed_at:
          type: string
          format: date-time
          description: >-
            The date/time that the clinician signed the communication with the
            customer (if it was signed)
          nullable: true
        read_at:
          type: string
          format: date-time
          description: The date/time that the patient read the response
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    Responder:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
    SymptomResponse:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        severity:
          type: string
        value:
          type: string
        recorded_on:
          type: string
          format: date-time
    AlertTier:
      type: object
      properties:
        tier:
          type: number
        automatic_alert:
          type: boolean
        triage_dash_tag:
          type: string
        triage_dash_label:
          type: string
        triage_dash_label_icon:
          type: boolean
    SymptomEducation:
      type: object
      properties:
        category:
          type: object
          properties:
            name:
              type: string
        body:
          type: string
          description: String containing the symptom education
        external_links:
          type: array
          items:
            type: object
            properties:
              title:
                type: string
              url:
                type: string
    QuestionnaireResponse:
      type: object
      properties:
        id:
          type: string
        is_alerted:
          type: boolean
          description: >-
            Whether the symptoms reported by the patient triggered an
            alert
        alert_tier:
          $ref: '#/components/schemas/AlertTier'
        care_team_response:
          $ref: '#/components/schemas/CareTeamResponse'
        symptoms:
          type: object
          description: The symptoms reported by the patient via the phone app
          properties:
            severe:
              type: object
              additionalProperties:
                type: array
                items:
                  $ref: '#/components/schemas/SymptomResponse'
            non_severe:
              type: object
              additionalProperties:
                type: array
                items:
                  $ref: '#/components/schemas/SymptomResponse'
        write_in:
          type: string
          description: >-
            Custom string entered by the patient while reporting
            symptoms
          nullable: true
        symptom_educations:
          type: array
          items:
            $ref: '#/components/schemas/SymptomEducation'
          nullable: true
        completed_on:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
    PatientReportedSymptomsResponse:
      allOf:
        - $ref: "#/components/schemas/AbstractResponse"
        - type: object
          properties:
            data:
              type: object
              properties:
                permissions:
                  description: Per-patient permissions granted to the provider
                  type: object
                  properties:
                    write_enabled:
                      type: boolean
                      description: Whether the provider is able to send a care team response message
                    allowed_responses:
                      type: object
                      additionalProperties:
                        type: string
                      description: Key-value pairs where keys are an enum of allowed responses a provider may send to a patient, and the values are the display values of the enum
                active_responses:
                  type: array
                  items:
                    $ref: '#/components/schemas/QuestionnaireResponse'
                inactive_responses:
                  type: array
                  items:
                    $ref: '#/components/schemas/QuestionnaireResponse'
    Error:
      allOf:
        - $ref: "#/components/schemas/AbstractResponse"
        - type: object
          properties:
            id:
              type: string
              description: Unique identifier for the error
            title:
              type: string
              description: Human readable message the describes the type of failure
            detail_message:
              type: string
              description: Human readable message that describes the specific failure
            detail:
              type: object
              additionalProperties: true
              description: An object that can convey structured information to the client. The schema of the object MUST be definable based on the code attribute
              nullable: true
            code:
              type: string
              description: An application specific error code string. This MAY be included if there is value providing an opaque error classification that can be used to lookup relevant documentation
              nullable: true
            status:
              type: string
              description: HTTP status of the response
  examples:
    CreateCareTeamResponseExample:
      summary: Create Care Team Response Example
      value:
        meta:
          links:
            self: /v1/care_team_response
          version: 1.0.0
        data:
          id: 25e4822e-c289-11ed-afa1-0242ac120002
          survey_response_id: 9970ca54-c289-11ed-afa1-0242ac120002
          responder:
            id: 2cc29228-c281-11ed-afa1-0242ac120002
            name: Susan Smith
          patient_id: 9d63650e-c289-11ed-afa1-0242ac120002
          patient_message:
            option: schedule_visit
            display: Schedule Visit
            comment: You should get in to see the doctor this week
          internal_note: Patient needs blood drawn
          read_at: null
          signed_at: null
          created_at: '2023-01-12T07:23:13.837Z'
          updated_at: '2023-01-12T07:23:13.837Z'
    SignCareTeamResponseExample:
      summary: Sign Care Team Response Draft Example
      value:
        meta:
          links:
            self: /v1/care_team_response/25e4822e-c289-11ed-afa1-0242ac120002/sign
          version: 1.0.0
        data:
          id: 25e4822e-c289-11ed-afa1-0242ac120002
          survey_response_id: 9970ca54-c289-11ed-afa1-0242ac120002
          responder:
            id: 2cc29228-c281-11ed-afa1-0242ac120002
            name: Susan Smith
          patient_id: 9d63650e-c289-11ed-afa1-0242ac120002
          patient_message:
            option: schedule_visit
            display: Schedule Visit
            comment: You should get in to see the doctor this week
          internal_note: Patient needs blood drawn
          read_at: null
          signed_at: '2023-01-12T07:23:13.837Z'
          created_at: '2023-01-12T07:23:13.837Z'
          updated_at: '2023-01-12T07:23:13.837Z'
    MarkCareTeamResponseAsReadExample:
      summary: Upsert Care Team Response Draft Example
      value:
        meta:
          links:
            self: /v1/care_team_response/25e4822e-c289-11ed-afa1-0242ac120002/read
          version: 1.0.0
        data:
          id: 25e4822e-c289-11ed-afa1-0242ac120002
          survey_response_id: 9970ca54-c289-11ed-afa1-0242ac120002
          responder:
            id: 2cc29228-c281-11ed-afa1-0242ac120002
            name: Susan Smith
          patient_id: 9d63650e-c289-11ed-afa1-0242ac120002
          patient_message:
            option: schedule_visit
            display: Schedule Visit
            comment: You should get in to see the doctor this week
          internal_note: Patient needs blood drawn
          read_at: '2023-01-12T09:48:54.826Z'
          signed_at: '2023-01-12T07:23:13.837Z'
          created_at: '2023-01-12T07:23:13.837Z'
          updated_at: '2023-01-12T07:23:13.837Z'
    PatientReportedSymptomsResponseExample:
      summary: Completed Questionnaire
      value:
        meta:
          links:
            self: /v1/symptoms/27ce169e-c280-11ed-afa1-0242ac120002
          version: 1.0.0
        data:
          permissions:
            write_enabled: true
            allowed_responses:
              address_before : "Will address: Before next appt"
              address_next: "Will address: At next appt"
              address_unneeded: "No need to address: Alert not needed"
              addressed_already: "No need to address: Already discussed"
          active_responses:
            - id: eef1b220-c754-11ed-afa1-0242ac120002
              is_alerted: true
              alert_tier:
                tier: 4
                automatic_alert: true
                triage_dash_tag: Patient told to call 911
                triage_dash_label: Urgent Response Required
                triage_dash_label_icon: true
              care_team_response: null
          inactive_responses:
            - id: 27ce169e-c280-11ed-afa1-0242ac120002
              is_alerted: true
              alert_tier:
                tier: 4
                automatic_alert: true
                triage_dash_tag: Patient told to call 911
                triage_dash_label: Urgent Response Required
                triage_dash_label_icon: true
              care_team_response:
                id: 1f82b782-c281-11ed-afa1-0242ac120002
                responder:
                  id: 2cc29228-c281-11ed-afa1-0242ac120002
                  name: Susan Smith
                patient_message:
                  option: address_next
                  display: "Will address: At next appt"
                  comment: "You'll be able to discuss this with the doctor at your next visit"
                internal_note: "Patient would like to discuss their vomitting with the doctor"
                signed_at: "2022-02-11T02:45:03.246Z"
                read_at: "2022-02-11T03:26:16.876Z"
                created_at: "2022-02-11T02:34:56.356"
                updated_at: "2022-02-11T03:26:16.876Z"
            - id: 36f5b5f4-c754-11ed-afa1-0242ac120002
              is_alerted: false
              alert_tier:
                tier: 1
                automatic_alert: false
                triage_dash_tag: ""
                triage_dash_label: "Mild, Non-Alerted Symptom"
                triage_dash_label_icon: false
              care_team_response: null
    BadRequestError:
      summary: Bad Request Error Example
      value:
        meta:
          links:
            self: /v1/care_team_response/10256
          version: 1.0.0
        errors:
          - id: 179F5161-D264-422B-8E2E-72B721739922
            title: Invalid Attribute
            detail_message: Attribute 'count' must be a positive value.
            code: VALIDATE-25
            detail:
              field: count
              value: '-1'
              message: Must be a positive value
            status: '400'
    DuplicateResource:
      summary: Bad Request - Duplicate Resource
      value:
        meta:
          links:
            self: /v1/care_team_response/10256
          version: 1.0.0
        errors:
          - id: 179F5161-D264-422B-8E2E-72B721739922
            title: Resource Already Exists
            detail_message: The care team response has already been stored and sent to the patient
            code: DUPLICATE
            status: '400'
    DuplicateSignature:
      summary: Duplicate Signature
      value:
        meta:
          links:
            self: /v1/care_team_response/10256
          version: 1.0.0
        errors:
          - id: 179F5161-D264-422B-8E2E-72B721739922
            title: Response Already Signed
            detail_message: The care team response has already been signed by a provider
            code: DUP_SIGNATURE
            status: '409'
    NotFoundError:
      summary: Resource Not Found Error Example
      value:
        meta:
          links:
            self: /v1/care_team_response/10256
          version: 1.0.0
        errors:
          - id: 179F5161-D264-422B-8E2E-72B721739922
            title: Resource Not Found
            detail_message: No survey response with the ID "10256" found
            status: '404'
    InternalServerError:
      summary: Internal Server Error
      value:
        meta:
          links:
            self: /v1/care_team_response/10256
          version: 1.0.0
        errors:
          - id: 179F5161-D264-422B-8E2E-72B721739922
            title: Internal Server Error
            detail_message: Lost connection with DB
            status: '500'
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
